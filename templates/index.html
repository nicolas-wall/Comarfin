<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Scoring Crediticio BCRA</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 0;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
        }

        input,
        select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }

        button:hover {
            background-color: #0056b3;
        }

        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .no-data {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .loading {
            text-align: center;
            color: #666;
            display: none;
        }

        /* History table styles */
        #history-section {
            margin-top: 1.5rem;
            display: none;
        }

        #history-section h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .history-table th,
        .history-table td {
            padding: 0.5rem 0.75rem;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .history-table th {
            background-color: #343a40;
            color: white;
            font-weight: 600;
        }

        .history-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .sit-ok {
            color: #28a745;
            font-weight: bold;
        }

        .sit-warn {
            color: #ffc107;
            font-weight: bold;
        }

        .sit-bad {
            color: #dc3545;
            font-weight: bold;
        }

        /* AFIP Section */
        #afip-section {
            margin-top: 1.5rem;
            display: none;
            border-top: 2px solid #e0e0e0;
            padding-top: 1.5rem;
        }

        #afip-section h3 {
            color: #0056b3;
            margin-bottom: 0.75rem;
        }

        .afip-card {
            background: linear-gradient(135deg, #e8f0fe 0%, #f0f4ff 100%);
            border: 1px solid #b8d4fe;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .afip-card .label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .afip-card .value {
            font-size: 1rem;
            color: #333;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .afip-card .value:last-child {
            margin-bottom: 0;
        }

        .condition-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .badge-mono {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #b1dfbb;
        }

        .badge-ri {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .badge-dep {
            background-color: #ffeeba;
            color: #856404;
            border: 1px solid #ffd666;
        }

        .badge-auto {
            background-color: #e2d5f1;
            color: #4a1d8c;
            border: 1px solid #c3aee0;
        }

        .badge-none {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
        }

        .afip-impuestos {
            margin-top: 0.75rem;
        }

        .afip-impuestos summary {
            cursor: pointer;
            font-weight: 600;
            color: #333;
            padding: 0.5rem 0;
        }

        .afip-imp-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .afip-imp-table th,
        .afip-imp-table td {
            padding: 0.4rem 0.6rem;
            text-align: left;
            border: 1px solid #dee2e6;
        }

        .afip-imp-table th {
            background-color: #0056b3;
            color: white;
            font-weight: 600;
        }

        .afip-imp-table tr:nth-child(even) {
            background-color: #f0f4ff;
        }

        .estado-activo {
            color: #28a745;
            font-weight: bold;
        }

        .estado-inactivo {
            color: #999;
        }

        .afip-activities {
            margin-top: 0.5rem;
        }

        .afip-activities ul {
            margin: 0.25rem 0 0 1.25rem;
            padding: 0;
        }

        .afip-activities li {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 0.25rem;
        }

        .afip-partial {
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 1rem;
            color: #795548;
        }

        .afip-not-found {
            background: #fce4ec;
            border: 1px solid #ef9a9a;
            border-radius: 8px;
            padding: 1rem;
            color: #c62828;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Consulta BCRA + AFIP</h1>
        <form id="checkForm">
            <div class="form-group">
                <label for="dni">DNI / CUIT / CUIL</label>
                <input type="text" id="dni" name="dni" required placeholder="Ingrese n√∫meros sin guiones">
            </div>

            <div class="form-group">
                <label for="name">Nombre (Opcional)</label>
                <input type="text" id="name" name="name" placeholder="Nombre completo">
            </div>

            <div class="form-group">
                <label for="sex">Sexo (Requerido para c√°lculo de CUIL)</label>
                <select id="sex" name="sex" required>
                    <option value="">Seleccione...</option>
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                    <option value="X">No Binario / Otro</option>
                </select>
            </div>

            <button type="submit">Consultar Scoring + AFIP</button>
        </form>

        <div id="loading" class="loading">Consultando BCRA...</div>
        <div id="result"></div>
        <div id="history-section">
            <h3>üìä Resumen √∫ltimos 6 meses</h3>
            <div id="history-loading" class="loading" style="display:none;">Cargando historial...</div>
            <div id="history-content"></div>
        </div>

        <!-- AFIP Section -->
        <div id="afip-section">
            <h3>üèõÔ∏è Condici√≥n Fiscal ‚Äî AFIP</h3>
            <div id="afip-loading" class="loading" style="display:none;">Consultando AFIP...</div>
            <div id="afip-content"></div>
        </div>
    </div>

    <script>
        document.getElementById('checkForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const dni = document.getElementById('dni').value;
            const name = document.getElementById('name').value;
            const sex = document.getElementById('sex').value;

            const resultDiv = document.getElementById('result');
            const loadingDiv = document.getElementById('loading');
            const historySection = document.getElementById('history-section');
            const afipSection = document.getElementById('afip-section');

            // Reset UI
            resultDiv.style.display = 'none';
            resultDiv.className = '';
            loadingDiv.style.display = 'block';
            historySection.style.display = 'none';
            afipSection.style.display = 'none';

            try {
                const response = await fetch('/check_score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dni, name, sex }),
                });

                const data = await response.json();
                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'block';

                if (response.ok) {
                    const cuit = data.calculated_cuit || dni;

                    if (data.status === 'no_data') {
                        resultDiv.className = 'no-data';
                        resultDiv.innerHTML = `<strong>CUIT ${cuit}:</strong> ${data.message}`;
                        // Still try to fetch history and AFIP
                        fetchHistory(cuit);
                        fetchAfip(dni, sex, cuit);
                    } else if (data.status === 'success') {
                        resultDiv.className = 'success';

                        let html = `<h3>Situaci√≥n actual ‚Äî CUIT ${cuit}</h3>`;

                        data.data.forEach(item => {
                            const entity = item.periodos_entidades_entidad || 'Entidad desconocida';
                            const situation = item.periodos_entidades_situacion;
                            const amount = item.periodos_entidades_monto;

                            let situationText = `Situaci√≥n ${situation}`;
                            if (situation == 1) situationText += " (Normal)";
                            else situationText += " (Irregular)";

                            html += `<p><strong>Entidad:</strong> ${entity}<br>
                                 <strong>Situaci√≥n:</strong> ${situationText}<br>
                                 <strong>Monto:</strong> $${Number(amount).toLocaleString('es-AR')}</p><hr>`;
                        });

                        resultDiv.innerHTML = html;

                        // Fetch history and AFIP
                        fetchHistory(cuit);
                        fetchAfip(dni, sex, cuit);
                    } else {
                        resultDiv.className = 'error';
                        resultDiv.textContent = 'Respuesta inesperada del servidor.';
                    }
                } else {
                    resultDiv.className = 'error';
                    resultDiv.textContent = data.error || 'Error al consultar el servicio.';
                    if (data.details) resultDiv.textContent += ` ‚Äî ${data.details}`;
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultDiv.className = 'error';
                resultDiv.textContent = 'Error de conexi√≥n: ' + error.message;
            }
        });

        async function fetchHistory(cuit) {
            const historySection = document.getElementById('history-section');
            const historyLoading = document.getElementById('history-loading');
            const historyContent = document.getElementById('history-content');

            historySection.style.display = 'block';
            historyLoading.style.display = 'block';
            historyContent.innerHTML = '';

            try {
                const response = await fetch('/check_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cuit }),
                });

                const data = await response.json();
                historyLoading.style.display = 'none';

                if (response.ok && data.status === 'success') {
                    let personName = data.person_name || '';
                    let html = '';
                    if (personName && personName !== 'N/A') {
                        html += `<p><strong>Titular:</strong> ${personName}</p>`;
                    }

                    html += `<table class="history-table">
                        <thead>
                            <tr>
                                <th>Per√≠odo</th>
                                <th>Peor Situaci√≥n</th>
                                <th>Deuda Total</th>
                                <th>Entidades</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    data.history.forEach(month => {
                        let sitClass = 'sit-ok';
                        if (month.worst_situation >= 3) sitClass = 'sit-bad';
                        else if (month.worst_situation == 2) sitClass = 'sit-warn';

                        html += `<tr>
                            <td>${month.period}</td>
                            <td class="${sitClass}">${month.worst_situation}</td>
                            <td>$${Number(month.total_debt).toLocaleString('es-AR')}</td>
                            <td>${month.num_entities}</td>
                        </tr>`;
                    });

                    html += `</tbody></table>`;
                    historyContent.innerHTML = html;

                } else if (data.status === 'no_history') {
                    historyContent.innerHTML = `<p style="color:#856404;">${data.message}</p>`;
                } else {
                    historyContent.innerHTML = `<p style="color:#721c24;">Error al cargar historial: ${data.error || 'desconocido'}</p>`;
                }
            } catch (error) {
                historyLoading.style.display = 'none';
                historyContent.innerHTML = `<p style="color:#721c24;">Error de conexi√≥n al cargar historial.</p>`;
            }
        }

        async function fetchAfip(dni, sex, cuit) {
            const afipSection = document.getElementById('afip-section');
            const afipLoading = document.getElementById('afip-loading');
            const afipContent = document.getElementById('afip-content');

            afipSection.style.display = 'block';
            afipLoading.style.display = 'block';
            afipContent.innerHTML = '';

            try {
                const response = await fetch('/check_afip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dni, sex, cuit }),
                });

                const data = await response.json();
                afipLoading.style.display = 'none';

                if (response.ok && data.status === 'success') {
                    let html = `<div class="afip-card">`;

                    // Name & CUIT
                    html += `<div class="label">Contribuyente</div>`;
                    html += `<div class="value">${data.nombre || 'N/A'} ‚Äî CUIT ${data.cuit}</div>`;

                    // Estado
                    html += `<div class="label">Estado CUIT</div>`;
                    html += `<div class="value">${data.estado_clave} (${data.tipo_persona})</div>`;

                    // Condition badges
                    html += `<div class="label">Condici√≥n Fiscal</div>`;
                    html += `<div class="value">`;
                    if (data.is_monotributo) {
                        html += `<span class="condition-badge badge-mono">Monotributista${data.categoria_monotributo ? ' ‚Äî ' + data.categoria_monotributo : ''}</span>`;
                    }
                    if (data.is_responsable_inscripto) {
                        html += `<span class="condition-badge badge-ri">Responsable Inscripto</span>`;
                    }
                    if (data.is_relacion_dependencia) {
                        html += `<span class="condition-badge badge-dep">Rel. de Dependencia</span>`;
                    }
                    if (data.is_autonomo) {
                        html += `<span class="condition-badge badge-auto">Aut√≥nomo</span>`;
                    }
                    if (!data.is_monotributo && !data.is_responsable_inscripto && !data.is_relacion_dependencia && !data.is_autonomo) {
                        html += `<span class="condition-badge badge-none">Sin condici√≥n activa detectada</span>`;
                    }
                    html += `</div>`;

                    // Domicilio
                    if (data.domicilio) {
                        html += `<div class="label">Domicilio Fiscal</div>`;
                        html += `<div class="value">${data.domicilio}</div>`;
                    }

                    html += `</div>`; // close .afip-card

                    // Activities
                    if (data.actividades && data.actividades.length > 0) {
                        html += `<div class="afip-activities">`;
                        html += `<details><summary>üìã Actividades Econ√≥micas (${data.actividades.length})</summary>`;
                        html += `<ul>`;
                        data.actividades.forEach(act => {
                            html += `<li>${act}</li>`;
                        });
                        html += `</ul></details></div>`;
                    }

                    // Impuestos
                    if (data.impuestos && data.impuestos.length > 0) {
                        html += `<div class="afip-impuestos">`;
                        html += `<details><summary>üí∞ Impuestos Inscriptos (${data.impuestos.length})</summary>`;
                        html += `<table class="afip-imp-table">
                            <thead><tr><th>Impuesto</th><th>Estado</th><th>Desde</th></tr></thead>
                            <tbody>`;
                        data.impuestos.forEach(imp => {
                            const estadoClass = imp.estado === 'Activo' ? 'estado-activo' : 'estado-inactivo';
                            html += `<tr>
                                <td>${imp.descripcion}</td>
                                <td class="${estadoClass}">${imp.estado}</td>
                                <td>${imp.periodo}</td>
                            </tr>`;
                        });
                        html += `</tbody></table></details></div>`;
                    }

                    afipContent.innerHTML = html;

                } else if (data.status === 'partial') {
                    let html = `<div class="afip-partial">`;
                    html += `<strong>${data.nombre}</strong> ‚Äî CUIT ${data.cuit}<br>`;
                    html += `<em>${data.message}</em>`;
                    if (data.errors && data.errors.length) {
                        html += `<ul style="margin-top:0.5rem;">`;
                        data.errors.forEach(err => html += `<li>${err}</li>`);
                        html += `</ul>`;
                    }
                    html += `</div>`;
                    afipContent.innerHTML = html;

                } else if (data.status === 'not_found') {
                    afipContent.innerHTML = `<div class="afip-not-found">${data.message}</div>`;

                } else if (data.status === 'no_data') {
                    afipContent.innerHTML = `<div class="afip-not-found">${data.message}</div>`;

                } else {
                    afipContent.innerHTML = `<p style="color:#721c24;">Error AFIP: ${data.error || 'desconocido'}</p>`;
                }
            } catch (error) {
                afipLoading.style.display = 'none';
                afipContent.innerHTML = `<p style="color:#721c24;">Error de conexi√≥n al consultar AFIP.</p>`;
            }
        }
    </script>

</body>

</html>